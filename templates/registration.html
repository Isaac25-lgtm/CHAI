<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Registration System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1F4E78;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-card h2 {
            color: #1F4E78;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .required {
            color: #dc3545;
        }

        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error,
        .form-group select.error {
            border-color: #dc3545;
        }

        .form-group select:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .checkbox-group {
            display: flex;
            gap: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .checkbox-group.error {
            border-color: #dc3545;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            user-select: none;
            font-weight: normal;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .network-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .network-online {
            background: #d4edda;
            color: #155724;
        }

        .network-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #004085;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .instructions ol {
            padding-left: 20px;
            color: #004085;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .admin-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .admin-link a {
            color: #667eea;
            text-decoration: none;
        }

        .admin-link a:hover {
            text-decoration: underline;
        }

        .recent-submissions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .recent-submissions h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .recent-submissions h3::before {
            content: "üìã";
            font-size: 20px;
        }

        .submission-item {
            background: white;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .submission-item .check-icon {
            color: #28a745;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .submission-item .content {
            flex: 1;
        }

        .submission-item strong {
            color: #333;
            display: block;
        }

        .submission-item small {
            color: #666;
            display: block;
            margin-top: 5px;
        }

        .no-submissions {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .pending-participants {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .facility-group {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .facility-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .facility-header h3 {
            color: #1F4E78;
            margin: 0;
            font-size: 18px;
        }

        .facility-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .participant-list {
            margin-bottom: 15px;
        }

        .participant-item {
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-info {
            flex: 1;
        }

        .participant-info strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .participant-info small {
            color: #666;
            display: block;
        }

        .remove-participant {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .remove-participant:hover {
            background: #c82333;
        }

        .btn-submit-facility {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-submit-facility:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-submit-facility:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .checkbox-group {
                flex-direction: column;
                gap: 15px;
            }
            
            .facility-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1>üìã Participant Registration</h1>
                <div id="networkStatus" class="network-status">
                    <span id="statusIcon"></span>
                    <span id="statusText"></span>
                </div>
            </div>
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 15px;">
                <h2 style="color: #004085; font-size: 20px; margin: 0 0 5px 0;">EDIL Assessment</h2>
                <p style="color: #004085; margin: 0; font-size: 16px; font-weight: 500;">30th November to 7th December 2025</p>
            </div>
            <p>Enter participant details for registration and mobile money enrollment</p>
        </div>

        <!-- Alerts -->
        <div id="successAlert" class="alert alert-success"></div>
        <div id="errorAlert" class="alert alert-error"></div>

        <!-- Registration Form -->
        <div class="form-card">
            <h2>Enter Participant Information</h2>
            
            <form id="participantForm">
                <div class="form-group">
                    <label>Participant's Name <span class="required">*</span></label>
                    <input type="text" id="participantName" placeholder="Enter full name">
                    <span class="error-message" id="errorParticipantName">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Cadre <span class="required">*</span></label>
                    <input type="text" id="cadre" placeholder="e.g., Nurse, Doctor, CHW">
                    <span class="error-message" id="errorCadre">This field is required</span>
                </div>

                <div class="form-group">
                    <label>District <span class="required">*</span></label>
                    <select id="district" required>
                        <option value="">-- Select District --</option>
                    </select>
                    <span class="error-message" id="errorDistrict">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Health Facility <span class="required">*</span></label>
                    <select id="dutyStation" required disabled>
                        <option value="">-- Select District First --</option>
                    </select>
                    <span class="error-message" id="errorDutyStation">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Registration Date <span class="required">*</span></label>
                    <input type="date" id="registrationDate">
                    <span class="error-message" id="errorRegistrationDate">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Campaign Day Attendance <span class="required">*</span></label>
                    <div class="checkbox-group" id="campaignDays">
                        {% for day in range(1, campaign_days + 1) %}
                        <div class="checkbox-item">
                            <input type="checkbox" id="day{{ day }}" value="{{ day }}">
                            <label for="day{{ day }}">Day {{ day }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <span class="error-message" id="errorCampaignDays">Please select at least one campaign day</span>
                </div>

                <div class="form-group">
                    <label>Mobile Number Registered <span class="required">*</span></label>
                    <div style="display: flex; align-items: center;">
                        <span style="background: #f8f9fa; border: 1px solid #ddd; border-right: none; padding: 12px 15px; border-radius: 6px 0 0 6px; color: #666; font-weight: 500;">+256</span>
                        <input type="tel" id="mobileNumber" placeholder="701234567" style="border-radius: 0 6px 6px 0; border-left: none; flex: 1;">
                    </div>
                    <span class="error-message" id="errorMobileNumber">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Names Registered on Mobile Money (First & Last Names) <span class="required">*</span></label>
                    <input type="text" id="mobileMoneyName" placeholder="Enter first and last name">
                    <span class="error-message" id="errorMobileMoneyName">This field is required</span>
                </div>

                <button type="submit" class="btn btn-primary">
                    ‚ûï Add Participant
                </button>
            </form>

            <!-- Pending Participants by Facility -->
            <div id="pendingParticipants" class="pending-participants" style="display: none;">
                <h2 style="color: #1F4E78; margin-top: 30px; margin-bottom: 20px;">üìã Pending Participants (Grouped by Facility)</h2>
                <div id="facilityGroups"></div>
            </div>

            <!-- Recent Submissions Section (24 hour view) - NOW BELOW SUBMIT BUTTON -->
            <div id="recentSubmissions" class="recent-submissions" style="display: none;">
                <h3>Health Centers Worked On (Last 24 Hours)</h3>
                <div id="submissionsList"></div>
            </div>

            <!-- Instructions Section - NOW AT THE BOTTOM -->
            <div class="instructions">
                <h3>üìå Instructions:</h3>
                <ol>
                    <li>Fill in all required participant information above</li>
                    <li>Select campaign day attendance (at least one day must be selected)</li>
                    <li>Click "‚ûï Add Participant" to add to the list (participants are grouped by facility)</li>
                    <li>Repeat for all participants from the same facility</li>
                    <li>When ready, click "Submit All to CHAI" for each facility group</li>
                    <li>Data will automatically download to your device after submission</li>
                    <li>Health centers you've worked on appear in "Recent Submissions" for 24 hours</li>
                </ol>
            </div>

            <div class="admin-link">
                <small>Admin? <a href="/admin/login">Login here</a></small>
            </div>
        </div>
    </div>

    <script>
        // District to Health Facilities mapping
        const districtFacilities = {
            'Zombo': ['Warr HCIV', 'Holy Family Hospital - Nyapea'],
            'Terego': ['Yinga HCIII'],
            'Arua': ['Arua RRH', 'Arua Police HC III'],
            'Madi Okollo': ['Rhinocamp HCIV'],
            'Nebbi': ['Goli HCIV', 'Nebbi General Hospital'],
            'Maracha': ['St. Joseph - Maracha Hospital'],
            'Koboko': ['Koboko General Hospital'],
            'Yumbe': ['Midigo HCIV', 'Yumbe RRH'],
            'Obongi': ['Obongi HCIV'],
            'Moyo': ['Moyo General Hospital'],
            'Adjumani': ['Mungula HCIV', 'Adjumani Mission HC III'],
            'Kampala': ['Kisenyi HCIV', 'Uganda Cancer Institute', 'Mengo Hospital', 'Uganda Heart Institute', 'Mulago NRH', 'Butabika NRH', 'Kawempe NRH', 'Entebbe RRH'],
            'Kamwenge': ['Rukunyu Hospital'],
            'Kabarole': ['Kibiito HCIV', 'Virika Hospital', 'Katojo Main Prison'],
            'Fortportal': ['Fortportal RRH'],
            'Kyenjojo': ['Kyarusozi HCIII', 'Kyenjojo Hospital'],
            'Kyegegwa': ['Kyegegwa HCIV'],
            'Gulu': ['Gulu RRH', '4th Division Military Hospital - Gulu'],
            'Amuru': ['Lacor-Pabbo HC III'],
            'Nwoya': ['Anaka GH'],
            'Omoro': ['Lalogi HCIV'],
            'Kitgum': ['Kitgum General Hospital', 'St. Joseph Hospital - Kitgum'],
            'Lamwo': ['Madi Opei HCIV'],
            'Hoima': ['Hoima Police HC II', 'Azur HCIV', 'Hoima RRH'],
            'Masindi': ['Masindi General Hospital', 'Bwijanga HCIV'],
            'Buliisa': ['Biiso HCIV'],
            'Kikuube': ['Kikuube HCIV'],
            'Kagadi': ['St. Ambrose Charity HC IV'],
            'Busia': ['Masafu Hospital'],
            'Iganga': ['Iganga General Hospital', 'Bugono HCIV'],
            'Namutumba': ['Namutumba HCIII'],
            'Jinja': ['AIDS Information Centre Special Clinic', 'Jinja RRH', 'Jinja Main Prison'],
            'Kamuli': ['Kamuli General Hospital'],
            'Rukungiri': ['Kisiizi COU Hospital', 'St. Karoli  Lwanga - Nyakibale Hospital', 'Rukungiri Police HC II'],
            'Kanungu': ['Kihihi HCIV', 'Kambuga Hospital'],
            'Rukiga': ['Mparo HCIV'],
            'Kabale': ['Kamuganguzi HCIII', 'Kabale RRH'],
            'Kayunga': ['Kayunga RRH', 'Galiraya HCIII'],
            'Mukono': ['Mukono General Hospital', 'St. Francis Naggalama Hospital'],
            'Luweero': ['Bombo Military Hospital', 'Luweero General Hospital'],
            'Buvuma': ['Buvuma HCIV'],
            'Nakasongola': ['Nakasongola HCIV'],
            'Lira City': ['Lira RRH'],
            'Lira': ['Amach HCIV'],
            'Alebtong': ['Apala HCIII'],
            'Otuke': ['Orum HCIV'],
            'Apac': ['Apac Hospital'],
            'Amolatar': ['Amai Community  Hospital'],
            'Dokolo': ['Dokolo HCIV'],
            'Oyam': ['Anyeke HCIV'],
            'Mpigi': ['Mpigi HCIV'],
            'Butambala': ['Gombe Hospital'],
            'Gomba': ['Maddu HCIV'],
            'Ssembabule': ['Ssembabule HCIV'],
            'Kalungu': ['Villa Maria Hospital', 'Lukaya Health Care Services'],
            'Masaka': ['Masaka Police HC III', 'Masaka RRH'],
            'Sironko': ['Sironko Medical Centre HC III'],
            'Bulambuli': ['Muyembe HC IV'],
            'Kapchorwa': ['Kapchorwa Hospital'],
            'Kween': ['Kaproron HC IV'],
            'Mbale District': ['Busiu HC IV'],
            'Mbale City': ['Mbale RRH', 'Mbale Police HC III'],
            'Tororo': ['St. Anthony\'s Tororo Hospital'],
            'Mbarara': ['2nd Division HCIV - Makenke', 'Mbarara Regional Referral Hospital'],
            'Rwampara': ['Kinoni HCIV'],
            'Kazo': ['Kazo HCIV'],
            'Kiruhura': ['Rushere Community Hospital'],
            'Isingiro': ['Kabuyanda HCIII', 'Nakivale HCIII'],
            'Ibanda': ['Ruhoko Hospital'],
            'Amudat': ['Amudat Hospital'],
            'Nakapiripirit': ['Tokora HCIV'],
            'Napak': ['Matany Hospital'],
            'Moroto': ['Moroto RRH', 'Moroto Main Prison HCIII'],
            'Kaabong': ['Kaabong Hospital'],
            'Kotido': ['Kotido Hospital'],
            'Abim': ['Abim Hospital'],
            'Kassanda': ['St. Joseph Madudu HC III', 'Kassanda HCIV'],
            'Mubende': ['Mubende RRH', 'Anbar Hospital', 'Kabamba Barracks HC III'],
            'Mityana': ['Mityana Hospital'],
            'Kiboga': ['Kiboga Hospital'],
            'Kyankwanzi': ['Ntwetwe HCIV'],
            'Amuria': ['Amuria Hospital'],
            'Katakwi': ['Katakwi Hospital'],
            'Serere': ['Serere HCIV'],
            'Ngora': ['Ngora HCIV'],
            'Bukedea': ['Bukedea HCIV'],
            'Kumi': ['Kumi - Ongino Hospital'],
            'Soroti': ['Soroti RRH', 'Soroti Police HC III']
        };

        // Store pending participants grouped by facility
        let pendingParticipants = {};

        // Network status monitoring
        let networkStatus = navigator.onLine;

        function updateNetworkStatus() {
            networkStatus = navigator.onLine;
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDiv = document.getElementById('networkStatus');
            
            if (networkStatus) {
                statusDiv.className = 'network-status network-online';
                statusIcon.textContent = 'üü¢';
                statusText.textContent = 'Online';
            } else {
                statusDiv.className = 'network-status network-offline';
                statusIcon.textContent = 'üî¥';
                statusText.textContent = 'Offline';
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        updateNetworkStatus();

        // Set today's date as default and initialize district/facility dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('registrationDate').value = today;
            
            // Populate district dropdown
            const districtSelect = document.getElementById('district');
            const districts = Object.keys(districtFacilities).sort();
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            
            // Add event listener for district change
            districtSelect.addEventListener('change', function() {
                updateFacilityDropdown(this.value);
            });
            
            displayRecentSubmissions();
            loadPendingParticipants();
            renderPendingParticipants();
        });

        // Update facility dropdown based on selected district
        function updateFacilityDropdown(selectedDistrict) {
            const facilitySelect = document.getElementById('dutyStation');
            facilitySelect.innerHTML = '<option value="">-- Select Health Facility --</option>';
            
            if (selectedDistrict && districtFacilities[selectedDistrict]) {
                facilitySelect.disabled = false;
                const facilities = districtFacilities[selectedDistrict].sort();
                facilities.forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility;
                    option.textContent = facility;
                    facilitySelect.appendChild(option);
                });
            } else {
                facilitySelect.disabled = true;
                facilitySelect.innerHTML = '<option value="">-- Select District First --</option>';
            }
        }

        // Load pending participants from localStorage
        function loadPendingParticipants() {
            try {
                const stored = localStorage.getItem('pendingParticipants');
                if (stored) {
                    pendingParticipants = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading pending participants:', e);
                pendingParticipants = {};
            }
        }

        // Save pending participants to localStorage
        function savePendingParticipants() {
            try {
                localStorage.setItem('pendingParticipants', JSON.stringify(pendingParticipants));
            } catch (e) {
                console.error('Error saving pending participants:', e);
            }
        }

        // Add participant to pending list
        function addPendingParticipant(participant) {
            const facility = participant.facility;
            if (!pendingParticipants[facility]) {
                pendingParticipants[facility] = [];
            }
            // Add unique ID to participant
            participant.id = Date.now() + Math.random();
            pendingParticipants[facility].push(participant);
            savePendingParticipants();
            renderPendingParticipants();
        }

        // Remove participant from pending list (global function for onclick)
        window.removePendingParticipant = function(facility, participantId) {
            if (pendingParticipants[facility]) {
                pendingParticipants[facility] = pendingParticipants[facility].filter(
                    p => p.id !== participantId
                );
                if (pendingParticipants[facility].length === 0) {
                    delete pendingParticipants[facility];
                }
                savePendingParticipants();
                renderPendingParticipants();
            }
        };

        // Render pending participants grouped by facility
        function renderPendingParticipants() {
            const container = document.getElementById('pendingParticipants');
            const groupsContainer = document.getElementById('facilityGroups');
            
            const facilities = Object.keys(pendingParticipants);
            
            if (facilities.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            groupsContainer.innerHTML = '';
            
            facilities.forEach(facility => {
                const participants = pendingParticipants[facility];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'facility-group';
                
                groupDiv.innerHTML = `
                    <div class="facility-header">
                        <h3>üè• ${facility}</h3>
                        <span class="facility-count">${participants.length} participant${participants.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="participant-list">
                        ${participants.map((p, idx) => `
                            <div class="participant-item">
                                <div class="participant-info">
                                    <strong>${p.participant_name}</strong>
                                    <small>${p.cadre} | ${p.district} | ${p.mobile_number}</small>
                                    <small>Days: ${Object.keys(p).filter(k => k.startsWith('day') && p[k]).map(k => k.replace('day', 'Day ')).join(', ') || 'None'}</small>
                                </div>
                                <button class="remove-participant" onclick="removePendingParticipant('${facility}', ${p.id})">
                                    Remove
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-submit-facility" onclick="submitFacility('${facility}')" id="submitBtn_${facility.replace(/\s+/g, '_')}">
                        üì§ Submit All to CHAI (${participants.length} participant${participants.length !== 1 ? 's' : ''})
                    </button>
                `;
                
                groupsContainer.appendChild(groupDiv);
            });
        }

        // Submit all participants from a facility (global function for onclick)
        window.submitFacility = async function(facility) {
            const participants = pendingParticipants[facility];
            if (!participants || participants.length === 0) {
                showAlert('No participants to submit for this facility.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById(`submitBtn_${facility.replace(/\s+/g, '_')}`);
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting to CHAI...';
            
            try {
                const response = await fetch('/submit/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ participants: participants })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store facility submission locally for 24 hour tracking (not individual participants)
                    try {
                        const facilitySubmission = {
                            facility: facility,
                            district: participants[0].district,
                            participant_count: result.count,
                            submitted_at: new Date().toISOString()
                        };
                        const submissionKey = `facility_submission:${facility}:${Date.now()}`;
                        localStorage.setItem(submissionKey, JSON.stringify(facilitySubmission));
                    } catch (storageError) {
                        console.error('Storage error:', storageError);
                    }
                    
                    // Remove submitted participants from pending list
                    delete pendingParticipants[facility];
                    savePendingParticipants();
                    renderPendingParticipants();
                    
                    showAlert(`‚úÖ Successfully submitted ${result.count} participant(s) from ${facility} to CHAI!`, 'success');
                    
                    // Trigger automatic download
                    setTimeout(() => {
                        downloadFacilityData(facility);
                    }, 500);
                    
                    displayRecentSubmissions();
                } else {
                    showAlert('‚ùå Error: ' + result.error, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = `üì§ Submit All to CHAI (${participants.length} participant${participants.length !== 1 ? 's' : ''})`;
                }
            } catch (error) {
                showAlert('‚ùå Network error. Please check your connection and try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = `üì§ Submit All to CHAI (${participants.length} participant${participants.length !== 1 ? 's' : ''})`;
            }
        };

        // Download facility data
        function downloadFacilityData(facility) {
            try {
                // Encode facility name for URL
                const encodedFacility = encodeURIComponent(facility);
                const downloadUrl = `/download/facility/${encodedFacility}`;
                
                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${facility}_registrations.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`üì• Downloading data for ${facility}...`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showAlert('‚ö†Ô∏è Data submitted successfully, but automatic download failed. You can download it from the admin dashboard.', 'error');
            }
        }

        // Display recent submissions (last 24 hours) - showing only facilities
        function displayRecentSubmissions() {
            try {
                const facilitySubmissions = [];
                const now = new Date().getTime();
                const twentyFourHours = 24 * 60 * 60 * 1000;
                const facilityMap = new Map(); // To group by facility and get latest submission

                // Clean up old individual submission entries (legacy)
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('submission:') && !key.startsWith('facility_submission:')) {
                        localStorage.removeItem(key);
                    }
                }

                // Get all keys from localStorage that start with 'facility_submission:'
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('facility_submission:')) {
                        try {
                            const value = localStorage.getItem(key);
                            if (value) {
                                const submission = JSON.parse(value);
                                const submittedTime = new Date(submission.submitted_at).getTime();
                                
                                // Check if within 24 hours
                                if (now - submittedTime <= twentyFourHours) {
                                    const facility = submission.facility;
                                    // Keep only the most recent submission for each facility
                                    if (!facilityMap.has(facility) || 
                                        new Date(submission.submitted_at) > new Date(facilityMap.get(facility).submitted_at)) {
                                        facilityMap.set(facility, submission);
                                    }
                                } else {
                                    // Delete old submissions
                                    localStorage.removeItem(key);
                                }
                            }
                        } catch (e) {
                            console.error('Error processing submission:', e);
                            localStorage.removeItem(key);
                        }
                    }
                }

                // Convert map to array and sort by submission time (newest first)
                facilitySubmissions.push(...facilityMap.values());
                facilitySubmissions.sort((a, b) => 
                    new Date(b.submitted_at) - new Date(a.submitted_at)
                );

                if (facilitySubmissions.length > 0) {
                    const submissionsList = document.getElementById('submissionsList');
                    submissionsList.innerHTML = facilitySubmissions.map(sub => `
                        <div class="submission-item">
                            <div class="check-icon">‚úì</div>
                            <div class="content">
                                <strong>üè• ${sub.facility}</strong>
                                <small>${sub.district} | ${sub.participant_count} participant${sub.participant_count !== 1 ? 's' : ''} submitted</small>
                                <small>Submitted: ${new Date(sub.submitted_at).toLocaleString()}</small>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentSubmissions').style.display = 'block';
                } else {
                    document.getElementById('recentSubmissions').style.display = 'none';
                }
            } catch (error) {
                console.error('Error displaying recent submissions:', error);
            }
        }

        function showAlert(message, type) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alertElement = document.getElementById(alertId);
            alertElement.innerHTML = message.replace(/\n/g, '<br>');
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        function validatePhoneNumber(phone) {
            const pattern = /^7\d{8}$/;
            const cleanPhone = phone.replace(/\s/g, '');
            if (cleanPhone.startsWith('0')) {
                return false;
            }
            return pattern.test(cleanPhone);
        }

        function validateForm() {
            let isValid = true;
            const fields = ['participantName', 'cadre', 'dutyStation', 'district', 'mobileNumber', 'mobileMoneyName', 'registrationDate'];
            
            fields.forEach(field => {
                const input = document.getElementById(field);
                const errorField = field.charAt(0).toUpperCase() + field.slice(1);
                const error = document.getElementById('error' + errorField);
                
                // For select elements, check if value is empty
                const isEmpty = input.tagName === 'SELECT' ? !input.value : !input.value.trim();
                
                if (isEmpty) {
                    input.classList.add('error');
                    error.style.display = 'block';
                    isValid = false;
                } else if (field === 'mobileNumber' && !validatePhoneNumber(input.value.trim())) {
                    input.classList.add('error');
                    error.textContent = 'Invalid phone format. Enter 9 digits starting with 7 (e.g., 701234567). Do not start with 0.';
                    error.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('error');
                    error.style.display = 'none';
                }
            });
            
            // Validate campaign days (dynamic based on number of days)
            const campaignGroup = document.getElementById('campaignDays');
            const campaignError = document.getElementById('errorCampaignDays');
            const dayCheckboxes = campaignGroup.querySelectorAll('input[type="checkbox"]');
            const atLeastOneChecked = Array.from(dayCheckboxes).some(cb => cb.checked);
            
            if (!atLeastOneChecked) {
                campaignGroup.classList.add('error');
                campaignError.style.display = 'block';
                isValid = false;
            } else {
                campaignGroup.classList.remove('error');
                campaignError.style.display = 'none';
            }
            
            return isValid;
        }

        document.getElementById('mobileNumber').addEventListener('input', function(e) {
            const value = e.target.value;
            if (value.startsWith('0')) {
                e.target.value = value.substring(1);
            }
            if (value.length > 9) {
                e.target.value = value.substring(0, 9);
            }
        });

        document.getElementById('participantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            // Get all day checkboxes dynamically
            const campaignDays = document.getElementById('campaignDays');
            const dayCheckboxes = campaignDays.querySelectorAll('input[type="checkbox"]');
            const participant = {
                participant_name: document.getElementById('participantName').value.trim(),
                cadre: document.getElementById('cadre').value.trim(),
                district: document.getElementById('district').value.trim(),
                facility: document.getElementById('dutyStation').value.trim(),
                registration_date: document.getElementById('registrationDate').value,
                mobile_number: '+256' + document.getElementById('mobileNumber').value.trim(),
                mm_registered_names: document.getElementById('mobileMoneyName').value.trim()
            };
            
            // Add day checkboxes dynamically (support up to 7 days)
            dayCheckboxes.forEach((checkbox, index) => {
                const dayNum = index + 1;
                participant[`day${dayNum}`] = checkbox.checked;
            });
            
            // Add to pending participants
            addPendingParticipant(participant);
            
            showAlert('‚úÖ Participant added to list! Continue adding participants from the same facility, then click "Submit All to CHAI" when ready.', 'success');
            
            // Reset form but keep district, facility and date
            const district = participant.district;
            const facility = participant.facility;
            const regDate = participant.registration_date;
            this.reset();
            document.getElementById('district').value = district;
            updateFacilityDropdown(district);
            document.getElementById('dutyStation').value = facility;
            document.getElementById('registrationDate').value = regDate;
            
            // Scroll to pending participants section
            setTimeout(() => {
                document.getElementById('pendingParticipants').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        });
    </script>
</body>
</html>

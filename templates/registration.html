<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Registration System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1F4E78;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-card h2 {
            color: #1F4E78;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .required {
            color: #dc3545;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            background-color: white;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group select option {
            padding: 10px;
        }

        .form-group input.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-download {
            background: #17a2b8;
            color: white;
        }

        .btn-download:hover {
            background: #138496;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .table-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-container h2 {
            color: #1F4E78;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: #1F4E78;
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            font-weight: 600;
            font-size: 14px;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e9ecef;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .action-buttons .btn {
            flex: 1;
        }

        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #004085;
            margin-bottom: 15px;
        }

        .instructions ol {
            padding-left: 20px;
            color: #004085;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .back-btn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .header div {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1>üìã Participant Registration</h1>
                <a href="/" class="back-btn">‚Üê Back to Portal</a>
            </div>
            <p>Enter participant details for registration and mobile money enrollment</p>
        </div>

        <!-- Alerts -->
        <div id="successAlert" class="alert alert-success"></div>
        <div id="errorAlert" class="alert alert-error"></div>

        <!-- Registration Form -->
        <div class="form-card">
            <h2>Enter Participant Information</h2>
            
            <form id="participantForm">
                <div class="form-group">
                    <label>Participant's Name <span class="required">*</span></label>
                    <input type="text" id="participantName" placeholder="Enter full name">
                    <span class="error-message" id="errorParticipantName">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Cadre <span class="required">*</span></label>
                    <input type="text" id="cadre" placeholder="e.g., Nurse, Doctor, CHW">
                    <span class="error-message" id="errorCadre">This field is required</span>
                </div>

                <div class="form-group">
                    <label>District <span class="required">*</span></label>
                    <select id="district" onchange="updateFacilities()">
                        <option value="">Select District</option>
                        <option value="Agago District">Agago District</option>
                        <option value="Amuru District">Amuru District</option>
                        <option value="Gulu City">Gulu City</option>
                        <option value="Gulu District">Gulu District</option>
                        <option value="Kitgum District">Kitgum District</option>
                        <option value="Lamwo District">Lamwo District</option>
                        <option value="Omoro District">Omoro District</option>
                        <option value="Pader District">Pader District</option>
                    </select>
                    <span class="error-message" id="errorDistrict">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Facility <span class="required">*</span></label>
                    <select id="dutyStation">
                        <option value="">Select District first</option>
                    </select>
                    <span class="error-message" id="errorDutyStation">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Registration Date <span class="required">*</span></label>
                    <input type="date" id="registrationDate" onchange="validateDate(this, 'registration')">
                    <span class="error-message" id="errorRegistrationDate">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Campaign Day (Optional)</label>
                    <select id="campaignDay">
                        <option value="">Not part of 14-day campaign</option>
                        <option value="1">Day 1</option>
                        <option value="2">Day 2</option>
                        <option value="3">Day 3</option>
                        <option value="4">Day 4</option>
                        <option value="5">Day 5</option>
                        <option value="6">Day 6</option>
                        <option value="7">Day 7</option>
                        <option value="8">Day 8</option>
                        <option value="9">Day 9</option>
                        <option value="10">Day 10</option>
                        <option value="11">Day 11</option>
                        <option value="12">Day 12</option>
                        <option value="13">Day 13</option>
                        <option value="14">Day 14</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Mobile Number Registered <span class="required">*</span></label>
                    <div style="display: flex; align-items: center;">
                        <span style="background: #f8f9fa; border: 1px solid #ddd; border-right: none; padding: 12px 15px; border-radius: 6px 0 0 6px; color: #666; font-weight: 500;">+256</span>
                        <input type="tel" id="mobileNumber" placeholder="701234567" style="border-radius: 0 6px 6px 0; border-left: none; flex: 1;">
                    </div>
                    <span class="error-message" id="errorMobileNumber">This field is required</span>
                </div>

                <div class="form-group">
                    <label>Names Registered on Mobile Money (First & Last Names) <span class="required">*</span></label>
                    <input type="text" id="mobileMoneyName" placeholder="Enter first and last name">
                    <span class="error-message" id="errorMobileMoneyName">This field is required</span>
                </div>

                <button type="submit" class="btn btn-primary">
                    ‚ûï Add Participant
                </button>
            </form>
        </div>

        <!-- Participants Table -->
        <div id="tableContainer" class="table-container" style="display: none;">
            <h2>Registered Participants (<span id="participantCount">0</span>)</h2>
            
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Participant's Name</th>
                            <th>Cadre</th>
                            <th>Duty Station (Facility)</th>
                            <th>District</th>
                            <th>Mobile Number Registered</th>
                            <th>Names Registered on Mobile Money</th>
                            <th>Registration Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="participantsTableBody">
                    </tbody>
                </table>
            </div>

            <div class="action-buttons">
                <button onclick="downloadExcel()" class="btn btn-download">
                    üì• Download Excel
                </button>
                <button onclick="submitData()" class="btn btn-success" id="submitBtn">
                    ‚úâÔ∏è Confirm & Send to Email
                </button>
                <button onclick="clearForm()" class="btn btn-secondary" style="background: #6c757d;">
                    üóëÔ∏è Clear Form
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div id="instructions" class="instructions">
            <h3>üìå Instructions:</h3>
            <ol>
                <li>Fill in all required participant information above</li>
                <li>Click "Add Participant" to add them to the list</li>
                <li>Repeat for all participants you need to register</li>
                <li>Once done, click "Confirm & Send to Email" to generate and email the Excel file</li>
                <li>You can also download the Excel file directly using "Download Excel" button</li>
            </ol>
        </div>
    </div>

    <script>
        let participants = [];

        function showAlert(message, type) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alertElement = document.getElementById(alertId);
            alertElement.textContent = message;
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }

        function validatePhoneNumber(phone) {
            // Uganda phone format: 7XXXXXXXX (9 digits starting with 7, no leading 0)
            const pattern = /^7\d{8}$/;
            const cleanPhone = phone.replace(/\s/g, '');
            // Reject if it starts with 0
            if (cleanPhone.startsWith('0')) {
                return false;
            }
            return pattern.test(cleanPhone);
        }

        function fetchWithTimeout(url, options = {}, timeout = 30000) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        // Facilities data organized by district
        const facilitiesData = {
            'Agago District': [
                'Wol Health Centre III',
                'Paimol Health Centre III', 
                'Lira Kato Health Centre III',
                'Adilang Health Centre III',
                'Omot Health Centre III',
                'Dr. Ambrosoli Memorial Hospital',
                'Patongo Health Centre IV'
            ],
            'Amuru District': [
                'Amuru Lacor Health Centre III',
                'Lacor-Pabbo Health Centre III',
                'Pabor Health Centre III',
                'Olwal Health Centre III',
                'Kaladima Health Centre III',
                'Labongogali Health Centre III',
                'Atiak Health Centre IV'
            ],
            'Gulu City': [
                'Bardege Health Centre III',
                'St. Mary\'s Hospital Lacor',
                'Gulu Regional Referral Hospital',
                'Gulu Military General Hospital',
                'Layibi Techo Health Centre III',
                'Aywee Health Centre III',
                'Laroo Health Centre III',
                'Gulu Police Health Centre III'
            ],
            'Gulu District': [
                'Awach Health Centre IV',
                'Cwero Health Centre III',
                'Angaya Health Centre III',
                'Omel Health Centre III',
                'Labworomor Health Centre III',
                'Patiko Health Centre III'
            ],
            'Kitgum District': [
                'Pandwong Health Centre III',
                'Namokora Health Centre IV',
                'Omiya Anyima Health Centre III',
                'Kitgum-Matidi Health Centre III',
                'Orom Health Centre III',
                'Kitgum General Hospital',
                'St. Joseph\'s Kitgum Hospital'
            ],
            'Lamwo District': [
                'Lokung Health Centre III',
                'Paluda Health Centre III',
                'Agoro Health Centre III',
                'Akworo Health Centre III',
                'Palabek-Kal Health Centre IV',
                'Madi-Opei Health Centre IV',
                'Padibe Health Centre IV'
            ],
            'Omoro District': [
                'Lacor Opit Health Centre III',
                'Lalogi Health Centre IV',
                'Bobi Health Centre III',
                'Acet Health Centre III',
                'Lanenober Health Centre III',
                'Ongako Health Centre III',
                'Loyoajonga Health Centre III'
            ],
            'Pader District': [
                'Ogom Health Centre III',
                'Puranga Health Centre III',
                'Awere Health Centre III',
                'Pajule Health Centre IV',
                'Latanya Health Centre II',
                'Acholi-Bur Health Centre III',
                'Laguti Health Centre III'
            ]
        };

        function updateFacilities() {
            const districtSelect = document.getElementById('district');
            const facilitySelect = document.getElementById('dutyStation');
            
            // Clear existing options
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (districtSelect.value && facilitiesData[districtSelect.value]) {
                facilitiesData[districtSelect.value].forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility;
                    option.textContent = facility;
                    facilitySelect.appendChild(option);
                });
            }
        }

        function validateForm() {
            let isValid = true;
            const fields = ['participantName', 'cadre', 'dutyStation', 'district', 'mobileNumber', 'mobileMoneyName', 'registrationDate'];
            
            fields.forEach(field => {
                const input = document.getElementById(field);
                const error = document.getElementById('error' + field.charAt(0).toUpperCase() + field.slice(1));
                
                if (!input.value.trim()) {
                    input.classList.add('error');
                    error.style.display = 'block';
                    isValid = false;
                } else if (field === 'mobileNumber' && !validatePhoneNumber(input.value.trim())) {
                    input.classList.add('error');
                    error.textContent = 'Invalid phone format. Enter 9 digits starting with 7 (e.g., 701234567). Do not start with 0.';
                    error.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('error');
                    error.style.display = 'none';
                }
            });
            
            return isValid;
        }

        // Add real-time validation for mobile number input
        document.getElementById('mobileNumber').addEventListener('input', function(e) {
            const value = e.target.value;
            // Prevent typing 0 at the beginning
            if (value.startsWith('0')) {
                e.target.value = value.substring(1);
            }
            // Limit to 9 digits
            if (value.length > 9) {
                e.target.value = value.substring(0, 9);
            }
        });

        // Date validation function
        function validateDate(dateInput, formType) {
            const today = new Date().toISOString().split('T')[0];
            const selectedDate = dateInput.value;
            
            if (selectedDate && selectedDate !== today) {
                const formName = formType === 'registration' ? 'Registration' : 'Assessment';
                const message = `To enter a date other than today's date for ${formName}, please contact the administrators at:\n\nüìß eolal@clintonhealthaccess.org\nüìß omodingisaac111@gmail.com\n\nPlease reset the date to today's date or contact admins for assistance.`;
                
                alert(message);
                dateInput.value = today; // Reset to today's date
            }
        }

        // Set today's date as default for registration date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('registrationDate').value = today;
        });

        document.getElementById('participantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const participant = {
                participantName: document.getElementById('participantName').value.trim(),
                cadre: document.getElementById('cadre').value.trim(),
                dutyStation: document.getElementById('dutyStation').value.trim(),
                district: document.getElementById('district').value.trim(),
                mobileNumber: '+256' + document.getElementById('mobileNumber').value.trim(),
                mobileMoneyName: document.getElementById('mobileMoneyName').value.trim(),
                registrationDate: document.getElementById('registrationDate').value,
                campaignDay: document.getElementById('campaignDay').value ? parseInt(document.getElementById('campaignDay').value) : null
            };
            
            participants.push(participant);
            updateTable();
            this.reset();
            showAlert('Participant added successfully!', 'success');
        });

        function updateTable() {
            const tbody = document.getElementById('participantsTableBody');
            tbody.innerHTML = '';
            
            participants.forEach((participant, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${participant.participantName}</td>
                    <td>${participant.cadre}</td>
                    <td>${participant.dutyStation}</td>
                    <td>${participant.district}</td>
                    <td>${participant.mobileNumber}</td>
                    <td>${participant.mobileMoneyName}</td>
                    <td>${participant.registrationDate}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteParticipant(${index})">üóëÔ∏è Delete</button>
                    </td>
                `;
            });
            
            document.getElementById('participantCount').textContent = participants.length;
            document.getElementById('tableContainer').style.display = participants.length > 0 ? 'block' : 'none';
            document.getElementById('instructions').style.display = participants.length > 0 ? 'none' : 'block';
        }

        function deleteParticipant(index) {
            if (confirm('Are you sure you want to delete this participant?')) {
                participants.splice(index, 1);
                updateTable();
                showAlert('Participant deleted successfully', 'success');
            }
        }

        let submissionCount = 0;

        async function submitData() {
            if (participants.length === 0) {
                showAlert('Please add at least one participant before submitting', 'error');
                return;
            }
            
            // First confirmation
            if (submissionCount === 0) {
                const confirm1 = confirm(`‚ö†Ô∏è FIRST CONFIRMATION\n\nYou are about to send ${participants.length} participant(s) data via email.\n\nThis is the FIRST of TWO required confirmations.\n\nClick OK to proceed to second confirmation.`);
                if (!confirm1) {
                    return;
                }
                submissionCount = 1;
                showAlert('Please click "Confirm & Send to Email" again to complete the submission (Second confirmation required)', 'success');
                return;
            }
            
            // Second confirmation
            if (submissionCount === 1) {
                const confirm2 = confirm(`‚úÖ SECOND CONFIRMATION (FINAL)\n\nThis is your final confirmation.\n\nAre you absolutely sure you want to send this data?\n\n- ${participants.length} participants will be registered\n- Data will be saved to database\n- Excel file will be generated\n- Email will be sent immediately\n\nClick OK to send now.`);
                if (!confirm2) {
                    submissionCount = 0;
                    return;
                }
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> Sending... Please wait';
            
            // Show delivery status
            showAlert('üì§ Sending data... Please wait for delivery confirmation', 'success');
            
            try {
                const response = await fetchWithTimeout('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ participants })
                }, 30000);
                
                const result = await response.json();
                
                if (result.success) {
                    submissionCount = 0;
                    showAlert('‚úÖ DELIVERED: ' + result.message + '\n\nüìß Email has been successfully sent and delivered!\n\nüíæ You can still download the Excel file below if needed.\n\nClick "Clear Form" when done to start fresh.', 'success');
                    // DON'T clear participants array yet - let user download first
                    // They can manually clear using the Clear Form button
                } else {
                    submissionCount = 0;
                    showAlert('‚ùå DELIVERY FAILED: ' + result.message, 'error');
                }
            } catch (error) {
                submissionCount = 0;
                showAlert('‚ùå ERROR: ' + error.message + '\n\nDelivery status: Failed', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function downloadExcel() {
            if (participants.length === 0) {
                showAlert('Please add at least one participant before downloading', 'error');
                return;
            }
            
            try {
                const response = await fetchWithTimeout('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ participants })
                }, 30000);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `participant_registration_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('Excel file downloaded successfully!', 'success');
                } else {
                    showAlert('Error downloading file', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function clearForm() {
            if (participants.length === 0) {
                showAlert('Form is already empty', 'info');
                return;
            }
            
            const confirmed = confirm(`‚ö†Ô∏è Clear Form?\n\nThis will remove all ${participants.length} participant(s) from the list.\n\nMake sure you've downloaded the Excel file if you need it!\n\nClick OK to clear the form.`);
            if (confirmed) {
                participants = [];
                submissionCount = 0;  // Reset submission counter
                updateTable();
                showAlert('‚úÖ Form cleared successfully! You can start adding new participants.', 'success');
            }
        }
    </script>
</body>
</html>
